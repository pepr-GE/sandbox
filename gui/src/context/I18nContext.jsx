import React, { createContext, useContext, useState, useEffect } from 'react'

// ── Translations ──────────────────────────────────────────────────────────────
const translations = {
  en: {
    appName: 'ANDONINO',
    nav: {
      messages: 'Messages',
      subscriptions: 'Subscriptions',
      admin: 'Admin',
    },
    broker: {
      connected: 'Broker connected',
      offline: 'Broker offline',
      checking: 'Checking…',
      status: 'Broker',
      connectedLabel: 'Connected',
      disconnectedLabel: 'Disconnected',
      unknown: 'Unknown',
    },
    auth: {
      signIn: 'Sign in to your account',
      username: 'Username',
      password: 'Password',
      signingIn: 'Signing in…',
      signInBtn: 'Sign In',
      logout: 'Logout',
      invalidCreds: 'Invalid username or password',
    },
    messages: {
      title: 'Received Messages',
      refresh: 'Refresh',
      filterByTopic: 'Filter by topic',
      from: 'From',
      to: 'To',
      clear: 'Clear',
      quickFilter: 'Quick filter:',
      found: (n) => `${n} message${n !== 1 ? 's' : ''} found`,
      noMessages: 'No messages found',
      colId: 'ID',
      colTopic: 'Topic',
      colPayload: 'Payload (preview)',
      colQos: 'QoS',
      colRetained: 'Retained',
      colReceivedAt: 'Received At',
      view: 'View',
      publish: 'Publish Message',
      detailTitle: 'Message Details',
      close: 'Close',
      payload: 'Payload',
      retained: 'Retained',
      yes: 'Yes',
      no: 'No',
    },
    subscriptions: {
      title: 'MQTT Subscriptions',
      addBtn: '+ Add Subscription',
      publishBtn: 'Publish Message',
      refresh: 'Refresh',
      colTopic: 'Topic Filter',
      colQos: 'QoS',
      colStatus: 'Status',
      colDesc: 'Description',
      colCreated: 'Created',
      colActions: 'Actions',
      active: 'active',
      paused: 'paused',
      pause: 'Pause',
      resume: 'Resume',
      edit: 'Edit',
      del: 'Delete',
      noSubs: (isAdmin) => `No subscriptions configured.${isAdmin ? ' Click "+ Add Subscription" to get started.' : ''}`,
      addTitle: 'Add Subscription',
      editTitle: 'Edit Subscription',
      topicFilter: 'Topic Filter',
      topicHint: 'Supports MQTT wildcards: # (multi-level) and + (single-level)',
      qos: 'QoS',
      description: 'Description',
      descPlaceholder: 'Optional description',
      cancel: 'Cancel',
      add: 'Add Subscription',
      save: 'Save',
      adding: 'Adding…',
      saving: 'Saving…',
      errCreate: 'Failed to create subscription',
      errUpdate: 'Failed to update subscription',
      errDelete: 'Failed to delete subscription',
      publishTitle: 'Publish Message',
      topic: 'Topic',
      topicPlaceholder: 'e.g. sensors/temperature',
      payloadLabel: 'Payload',
      payloadPlaceholder: 'e.g. {"value": 23.5}',
      retained: 'Retained',
      publishBtn2: 'Publish',
      publishing: 'Publishing…',
      publishSuccess: 'Message published successfully',
      errPublish: 'Failed to publish message',
      confirmDelete: (t) => `Delete subscription for "${t}"?`,
    },
    admin: {
      title: 'Administration',
      usersTab: 'Users',
      rolesTab: 'Roles',
      userCount: (n) => `${n} user${n !== 1 ? 's' : ''}`,
      roleCount: (n) => `${n} role${n !== 1 ? 's' : ''}`,
      newUser: '+ New User',
      newRole: '+ New Role',
      colUsername: 'Username',
      colEmail: 'Email',
      colRoles: 'Roles',
      colStatus: 'Status',
      colCreated: 'Created',
      colActions: 'Actions',
      colName: 'Name',
      colDesc: 'Description',
      active: 'active',
      inactive: 'inactive',
      edit: 'Edit',
      deactivate: 'Deactivate',
      deleteRole: 'Delete',
      userSaved: 'User saved successfully',
      roleCreated: 'Role created successfully',
      errDeactivate: 'Failed to deactivate user',
      errDeleteRole: (n) => `Failed to delete role`,
      confirmDeactivate: (u) => `Deactivate user "${u}"?`,
      confirmDeleteRole: (n) => `Delete role "${n}"?`,
      createUserTitle: 'Create User',
      editUserTitle: (u) => `Edit User: ${u}`,
      usernameLabel: 'Username',
      emailLabel: 'Email',
      passwordLabel: 'Password',
      passwordEditLabel: 'New Password (leave blank to keep)',
      rolesLabel: 'Roles',
      activeLabel: 'Active',
      cancel: 'Cancel',
      save: 'Save',
      saving: 'Saving…',
      errSaveUser: 'Failed to save user',
      createRoleTitle: 'Create Role',
      roleNameLabel: 'Name',
      roleNamePlaceholder: 'e.g. OPERATOR',
      roleDescLabel: 'Description',
      roleDescPlaceholder: 'Optional description',
      create: 'Create',
      creating: 'Creating…',
      errCreateRole: 'Failed to create role',
    },
    theme: { dark: 'Dark', light: 'Light', auto: 'Auto' },
    lang: { en: 'English', de: 'Deutsch', cs: 'Čeština' },
    sort: { asc: '↑', desc: '↓', none: '↕' },
  },

  de: {
    appName: 'ANDONINO',
    nav: {
      messages: 'Nachrichten',
      subscriptions: 'Abonnements',
      admin: 'Admin',
    },
    broker: {
      connected: 'Broker verbunden',
      offline: 'Broker offline',
      checking: 'Prüfe…',
      status: 'Broker',
      connectedLabel: 'Verbunden',
      disconnectedLabel: 'Getrennt',
      unknown: 'Unbekannt',
    },
    auth: {
      signIn: 'Anmelden',
      username: 'Benutzername',
      password: 'Passwort',
      signingIn: 'Anmelden…',
      signInBtn: 'Anmelden',
      logout: 'Abmelden',
      invalidCreds: 'Ungültiger Benutzername oder Passwort',
    },
    messages: {
      title: 'Empfangene Nachrichten',
      refresh: 'Aktualisieren',
      filterByTopic: 'Nach Thema filtern',
      from: 'Von',
      to: 'Bis',
      clear: 'Zurücksetzen',
      quickFilter: 'Schnellfilter:',
      found: (n) => `${n} Nachricht${n !== 1 ? 'en' : ''} gefunden`,
      noMessages: 'Keine Nachrichten gefunden',
      colId: 'ID',
      colTopic: 'Thema',
      colPayload: 'Inhalt (Vorschau)',
      colQos: 'QoS',
      colRetained: 'Gespeichert',
      colReceivedAt: 'Empfangen am',
      view: 'Anzeigen',
      publish: 'Nachricht senden',
      detailTitle: 'Nachrichtendetails',
      close: 'Schließen',
      payload: 'Inhalt',
      retained: 'Gespeichert',
      yes: 'Ja',
      no: 'Nein',
    },
    subscriptions: {
      title: 'MQTT-Abonnements',
      addBtn: '+ Abonnement hinzufügen',
      publishBtn: 'Nachricht senden',
      refresh: 'Aktualisieren',
      colTopic: 'Themenfilter',
      colQos: 'QoS',
      colStatus: 'Status',
      colDesc: 'Beschreibung',
      colCreated: 'Erstellt',
      colActions: 'Aktionen',
      active: 'aktiv',
      paused: 'pausiert',
      pause: 'Pausieren',
      resume: 'Fortsetzen',
      edit: 'Bearbeiten',
      del: 'Löschen',
      noSubs: (isAdmin) => `Keine Abonnements konfiguriert.${isAdmin ? ' Klicken Sie auf "+ Abonnement hinzufügen".' : ''}`,
      addTitle: 'Abonnement hinzufügen',
      editTitle: 'Abonnement bearbeiten',
      topicFilter: 'Themenfilter',
      topicHint: 'Unterstützt MQTT-Wildcards: # (mehrstufig) und + (einstufig)',
      qos: 'QoS',
      description: 'Beschreibung',
      descPlaceholder: 'Optionale Beschreibung',
      cancel: 'Abbrechen',
      add: 'Abonnement hinzufügen',
      save: 'Speichern',
      adding: 'Hinzufügen…',
      saving: 'Speichern…',
      errCreate: 'Abonnement konnte nicht erstellt werden',
      errUpdate: 'Abonnement konnte nicht aktualisiert werden',
      errDelete: 'Abonnement konnte nicht gelöscht werden',
      publishTitle: 'Nachricht senden',
      topic: 'Thema',
      topicPlaceholder: 'z.B. sensoren/temperatur',
      payloadLabel: 'Inhalt',
      payloadPlaceholder: 'z.B. {"wert": 23.5}',
      retained: 'Gespeichert',
      publishBtn2: 'Senden',
      publishing: 'Senden…',
      publishSuccess: 'Nachricht erfolgreich gesendet',
      errPublish: 'Nachricht konnte nicht gesendet werden',
      confirmDelete: (t) => `Abonnement für "${t}" löschen?`,
    },
    admin: {
      title: 'Administration',
      usersTab: 'Benutzer',
      rolesTab: 'Rollen',
      userCount: (n) => `${n} Benutzer`,
      roleCount: (n) => `${n} Rolle${n !== 1 ? 'n' : ''}`,
      newUser: '+ Neuer Benutzer',
      newRole: '+ Neue Rolle',
      colUsername: 'Benutzername',
      colEmail: 'E-Mail',
      colRoles: 'Rollen',
      colStatus: 'Status',
      colCreated: 'Erstellt',
      colActions: 'Aktionen',
      colName: 'Name',
      colDesc: 'Beschreibung',
      active: 'aktiv',
      inactive: 'inaktiv',
      edit: 'Bearbeiten',
      deactivate: 'Deaktivieren',
      deleteRole: 'Löschen',
      userSaved: 'Benutzer gespeichert',
      roleCreated: 'Rolle erstellt',
      errDeactivate: 'Benutzer konnte nicht deaktiviert werden',
      errDeleteRole: () => 'Rolle konnte nicht gelöscht werden',
      confirmDeactivate: (u) => `Benutzer "${u}" deaktivieren?`,
      confirmDeleteRole: (n) => `Rolle "${n}" löschen?`,
      createUserTitle: 'Benutzer erstellen',
      editUserTitle: (u) => `Benutzer bearbeiten: ${u}`,
      usernameLabel: 'Benutzername',
      emailLabel: 'E-Mail',
      passwordLabel: 'Passwort',
      passwordEditLabel: 'Neues Passwort (leer lassen zum Beibehalten)',
      rolesLabel: 'Rollen',
      activeLabel: 'Aktiv',
      cancel: 'Abbrechen',
      save: 'Speichern',
      saving: 'Speichern…',
      errSaveUser: 'Benutzer konnte nicht gespeichert werden',
      createRoleTitle: 'Rolle erstellen',
      roleNameLabel: 'Name',
      roleNamePlaceholder: 'z.B. OPERATOR',
      roleDescLabel: 'Beschreibung',
      roleDescPlaceholder: 'Optionale Beschreibung',
      create: 'Erstellen',
      creating: 'Erstellen…',
      errCreateRole: 'Rolle konnte nicht erstellt werden',
    },
    theme: { dark: 'Dunkel', light: 'Hell', auto: 'Auto' },
    lang: { en: 'English', de: 'Deutsch', cs: 'Čeština' },
    sort: { asc: '↑', desc: '↓', none: '↕' },
  },

  cs: {
    appName: 'ANDONINO',
    nav: {
      messages: 'Zprávy',
      subscriptions: 'Odběry',
      admin: 'Admin',
    },
    broker: {
      connected: 'Broker připojen',
      offline: 'Broker offline',
      checking: 'Kontrola…',
      status: 'Broker',
      connectedLabel: 'Připojen',
      disconnectedLabel: 'Odpojen',
      unknown: 'Neznámý',
    },
    auth: {
      signIn: 'Přihlaste se ke svému účtu',
      username: 'Uživatelské jméno',
      password: 'Heslo',
      signingIn: 'Přihlašování…',
      signInBtn: 'Přihlásit se',
      logout: 'Odhlásit se',
      invalidCreds: 'Neplatné uživatelské jméno nebo heslo',
    },
    messages: {
      title: 'Přijaté zprávy',
      refresh: 'Obnovit',
      filterByTopic: 'Filtrovat podle tématu',
      from: 'Od',
      to: 'Do',
      clear: 'Vymazat',
      quickFilter: 'Rychlý filtr:',
      found: (n) => `Nalezeno ${n} zpráv${n === 1 ? 'a' : n >= 2 && n <= 4 ? 'y' : ''}`,
      noMessages: 'Žádné zprávy nenalezeny',
      colId: 'ID',
      colTopic: 'Téma',
      colPayload: 'Obsah (náhled)',
      colQos: 'QoS',
      colRetained: 'Uchováno',
      colReceivedAt: 'Přijato',
      view: 'Zobrazit',
      publish: 'Odeslat zprávu',
      detailTitle: 'Detail zprávy',
      close: 'Zavřít',
      payload: 'Obsah',
      retained: 'Uchováno',
      yes: 'Ano',
      no: 'Ne',
    },
    subscriptions: {
      title: 'MQTT odběry',
      addBtn: '+ Přidat odběr',
      publishBtn: 'Odeslat zprávu',
      refresh: 'Obnovit',
      colTopic: 'Filtr tématu',
      colQos: 'QoS',
      colStatus: 'Stav',
      colDesc: 'Popis',
      colCreated: 'Vytvořeno',
      colActions: 'Akce',
      active: 'aktivní',
      paused: 'pozastaveno',
      pause: 'Pozastavit',
      resume: 'Obnovit',
      edit: 'Upravit',
      del: 'Smazat',
      noSubs: (isAdmin) => `Nejsou nakonfigurované žádné odběry.${isAdmin ? ' Klikněte na "+ Přidat odběr".' : ''}`,
      addTitle: 'Přidat odběr',
      editTitle: 'Upravit odběr',
      topicFilter: 'Filtr tématu',
      topicHint: 'Podporuje MQTT zástupné znaky: # (víceúrovňový) a + (jednoúrovňový)',
      qos: 'QoS',
      description: 'Popis',
      descPlaceholder: 'Volitelný popis',
      cancel: 'Zrušit',
      add: 'Přidat odběr',
      save: 'Uložit',
      adding: 'Přidávání…',
      saving: 'Ukládání…',
      errCreate: 'Nepodařilo se vytvořit odběr',
      errUpdate: 'Nepodařilo se aktualizovat odběr',
      errDelete: 'Nepodařilo se smazat odběr',
      publishTitle: 'Odeslat zprávu',
      topic: 'Téma',
      topicPlaceholder: 'např. senzory/teplota',
      payloadLabel: 'Obsah',
      payloadPlaceholder: 'např. {"hodnota": 23.5}',
      retained: 'Uchovat',
      publishBtn2: 'Odeslat',
      publishing: 'Odesílání…',
      publishSuccess: 'Zpráva úspěšně odeslána',
      errPublish: 'Nepodařilo se odeslat zprávu',
      confirmDelete: (t) => `Smazat odběr pro "${t}"?`,
    },
    admin: {
      title: 'Administrace',
      usersTab: 'Uživatelé',
      rolesTab: 'Role',
      userCount: (n) => `${n} uživatel${n === 1 ? '' : n >= 2 && n <= 4 ? 'é' : 'ů'}`,
      roleCount: (n) => `${n} rol${n === 1 ? 'e' : n >= 2 && n <= 4 ? 'e' : 'í'}`,
      newUser: '+ Nový uživatel',
      newRole: '+ Nová role',
      colUsername: 'Uživatelské jméno',
      colEmail: 'E-mail',
      colRoles: 'Role',
      colStatus: 'Stav',
      colCreated: 'Vytvořeno',
      colActions: 'Akce',
      colName: 'Název',
      colDesc: 'Popis',
      active: 'aktivní',
      inactive: 'neaktivní',
      edit: 'Upravit',
      deactivate: 'Deaktivovat',
      deleteRole: 'Smazat',
      userSaved: 'Uživatel uložen',
      roleCreated: 'Role vytvořena',
      errDeactivate: 'Nepodařilo se deaktivovat uživatele',
      errDeleteRole: () => 'Nepodařilo se smazat roli',
      confirmDeactivate: (u) => `Deaktivovat uživatele "${u}"?`,
      confirmDeleteRole: (n) => `Smazat roli "${n}"?`,
      createUserTitle: 'Vytvořit uživatele',
      editUserTitle: (u) => `Upravit uživatele: ${u}`,
      usernameLabel: 'Uživatelské jméno',
      emailLabel: 'E-mail',
      passwordLabel: 'Heslo',
      passwordEditLabel: 'Nové heslo (ponechte prázdné pro zachování)',
      rolesLabel: 'Role',
      activeLabel: 'Aktivní',
      cancel: 'Zrušit',
      save: 'Uložit',
      saving: 'Ukládání…',
      errSaveUser: 'Nepodařilo se uložit uživatele',
      createRoleTitle: 'Vytvořit roli',
      roleNameLabel: 'Název',
      roleNamePlaceholder: 'např. OPERATOR',
      roleDescLabel: 'Popis',
      roleDescPlaceholder: 'Volitelný popis',
      create: 'Vytvořit',
      creating: 'Vytváření…',
      errCreateRole: 'Nepodařilo se vytvořit roli',
    },
    theme: { dark: 'Tmavý', light: 'Světlý', auto: 'Auto' },
    lang: { en: 'English', de: 'Deutsch', cs: 'Čeština' },
    sort: { asc: '↑', desc: '↓', none: '↕' },
  },
}

// ── Detect browser/system language ───────────────────────────────────────────
function detectLang() {
  const stored = localStorage.getItem('app_lang')
  if (stored && translations[stored]) return stored
  const nav = navigator.language || navigator.languages?.[0] || 'en'
  const code = nav.split('-')[0].toLowerCase()
  return translations[code] ? code : 'en'
}

// ── Context ───────────────────────────────────────────────────────────────────
const I18nContext = createContext(null)

export function I18nProvider({ children }) {
  const [lang, setLangState] = useState(detectLang)

  const setLang = (l) => {
    localStorage.setItem('app_lang', l)
    setLangState(l)
  }

  const t = translations[lang]

  return (
    <I18nContext.Provider value={{ lang, setLang, t, availableLangs: Object.keys(translations) }}>
      {children}
    </I18nContext.Provider>
  )
}

export const useI18n = () => useContext(I18nContext)
